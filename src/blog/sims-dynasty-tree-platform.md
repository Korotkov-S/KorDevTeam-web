# SimsDynastyTree: разработка сервиса генеалогических древ на основе графов для фанатов The Sims

## Введение

Создание генеалогических древ — это сложная задача, требующая эффективной структуры данных для представления связей между людьми. Особенно это актуально для фанатов игры The Sims, которые хотят отслеживать сложные семейные истории на протяжении многих поколений. В этой статье мы расскажем о разработке веб-сервиса [SimsDynastyTree](https://simsdynastytree.com/ru) — специализированной платформы для создания и ведения детальных генеалогических древ Sims с использованием графов, кастомизацией, системой подписок и международными платежами.

## О проекте SimsDynastyTree

SimsDynastyTree — это онлайн-сервис, созданный фанатами The Sims для фанатов. Платформа превращает стандартную внутриигровую систему родства в мощный инструмент для глубокого сторителлинга и сохранения памяти о уникальных династиях. Сервис позволяет создавать неограниченное количество древ, добавлять детальную информацию о персонажах, кастомизировать внешний вид и делиться своими творениями с сообществом.

### Ключевые особенности платформы

- **Создание генеалогических древ** — построение сложных семейных структур
- **Реализация на графах** — эффективное хранение и отображение связей
- **Кастомизация** — визуальная настройка древ и персонажей
- **Детальные профили** — информация о родственниках, питомцах, себе
- **Медиа-альбомы** — прикрепление фотографий к персонажам и поколениям
- **Система подписок** — премиум-функции для расширенного функционала
- **Международные платежи** — возможность покупки подписки из-за рубежа

## Технические вызовы

### Основная задача: представление генеалогических древ

Генеалогическое древо — это сложная структура данных, которая требует:

1. **Представление связей** — родители, дети, супруги, братья/сестры
2. **Множественные связи** — один персонаж может иметь несколько супругов, детей от разных браков
3. **Циклические связи** — возможность связывания разных древ между собой
4. **Масштабируемость** — поддержка неограниченного количества поколений
5. **Визуализация** — отображение сложных структур в понятном виде

### Решение: использование графов

Графы — идеальная структура данных для представления генеалогических древ:

- **Узлы (вершины)** — персонажи (симы)
- **Рёбра (связи)** — отношения между персонажами
- **Типы связей** — родитель-ребенок, супруг-супруга, брат-сестра
- **Метаданные** — дополнительная информация о связях

## Архитектура решения

### Структура данных на основе графов

```
┌─────────────────────┐
│   Graph Database    │
│   (Neo4j/PostgreSQL)│
│                     │
│  Nodes:             │
│  - Characters       │
│  - Pets             │
│  - Trees            │
│                     │
│  Relationships:     │
│  - parent_of        │
│  - spouse_of        │
│  - sibling_of       │
│  - owner_of (pet)    │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  API Layer          │
│  - Graph Queries    │
│  - CRUD Operations  │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  Frontend           │
│  - Tree Visualization│
│  - Character Editor │
│  - Customization    │
└─────────────────────┘
```

### Технологический стек

**Frontend:**
- **Next.js** — React-фреймворк для SSR
- **TypeScript** — типизация
- **D3.js** или **Cytoscape.js** — визуализация графов
- **React Flow** — интерактивное построение древ
- **Tailwind CSS** — стилизация

**Backend:**
- **Node.js** + **AdonisJS** — серверная часть
- **PostgreSQL** с расширением для графов или **Neo4j** — графовая база данных
- **Redis** — кэширование
- **JWT** — аутентификация

**Интеграции:**
- **Stripe** / **PayPal** — международные платежи
- **Cloudinary** — хранение изображений
- **Email сервис** — уведомления

## Реализованные функции

### 1. Создание генеалогических древ на основе графов

#### Структура графа

Каждое древо представляет собой граф, где:

**Узлы (Nodes):**
- `Character` — персонаж (сим)
- `Pet` — питомец
- `Tree` — само древо (корневой узел)

**Связи (Relationships):**
- `PARENT_OF` — родитель → ребенок
- `SPOUSE_OF` — супруг ↔ супруга (двунаправленная)
- `SIBLING_OF` — брат/сестра ↔ брат/сестра
- `OWNER_OF` — владелец → питомец
- `BELONGS_TO` — персонаж → древо

#### Пример структуры данных

```
Tree "Династия Смитов"
  ├─ Character "Джон Смит" (родитель)
  │   ├─ PARENT_OF → Character "Мэри Смит"
  │   ├─ PARENT_OF → Character "Том Смит"
  │   └─ SPOUSE_OF ↔ Character "Джейн Смит"
  │
  ├─ Character "Мэри Смит"
  │   ├─ PARENT_OF → Character "Люси Смит"
  │   └─ SPOUSE_OF ↔ Character "Питер Джонс"
  │
  └─ Character "Том Смит"
      └─ OWNER_OF → Pet "Барсик"
```

#### Запросы к графу

**Найти всех потомков персонажа:**
```
MATCH (person:Character {id: $personId})
MATCH path = (person)-[:PARENT_OF*]->(descendant:Character)
RETURN descendant, path
```

**Найти всех предков:**
```
MATCH (person:Character {id: $personId})
MATCH path = (ancestor:Character)-[:PARENT_OF*]->(person)
RETURN ancestor, path
```

**Найти всех родственников (до 3-го колена):**
```
MATCH (person:Character {id: $personId})
MATCH path = (person)-[:PARENT_OF|SPOUSE_OF|SIBLING_OF*1..3]-(relative:Character)
WHERE relative.id <> person.id
RETURN DISTINCT relative, path
```

### 2. Детальные профили персонажей

Каждый персонаж может содержать обширную информацию:

#### Основная информация
- Имя и фамилия
- Фото/аватар
- Дата рождения
- Дата смерти (если применимо)
- Пол

#### Характеристики из игры
- Черты характера (Traits)
- Карьера
- Образование
- Жизненные цели (Aspirations)
- Навыки (Skills)

#### Дополнительная информация
- Место жительства
- Произвольные заметки
- Биография
- События жизни

#### Питомцы
- Связь с питомцами через отношение `OWNER_OF`
- Полная информация о питомцах (имя, порода, фото)

### 3. Кастомизация древ

Платформа предоставляет широкие возможности визуальной настройки:

#### Визуальные настройки древа
- **Цветовая схема** — выбор палитры для всего древа
- **Фон древа** — различные фоновые изображения
- **Стиль линий** — оформление связей между персонажами
- **Расположение** — горизонтальное, вертикальное, радиальное

#### Кастомизация персонажей
- **Стили аватаров** — различные варианты отображения
- **Премиум-аватары** — эксклюзивные стили для подписчиков
- **Размеры узлов** — настройка размера карточек персонажей
- **Иконки** — дополнительные визуальные элементы

#### Темы оформления
- Классическая
- Современная
- Игровая (в стиле The Sims)
- Кастомная (создание собственной темы)

### 4. Медиа-альбомы

Система позволяет прикреплять фотографии на разных уровнях:

- **К персонажу** — фото на разных возрастных стадиях
- **К поколению** — общие фото поколения
- **Ко всему древу** — семейные фото и события

**Функции:**
- Загрузка множественных изображений
- Организация в альбомы
- Подписи и описания
- Хронологическая сортировка

### 5. Связывание древ (премиум-функция)

Для премиум-пользователей доступна функция объединения разных династий:

- **Создание связей** между персонажами из разных древ
- **Сложные разветвленные вселенные** — объединение нескольких семейных линий
- **Визуализация** связанных древ
- **Навигация** между связанными древами

### 6. Публичные и приватные древа

Пользователи могут выбирать видимость своих древ:

- **Публичные древа** — доступны для просмотра всем
- **Приватные древа** — только для владельца
- **Публичные ссылки** — удобные URL для публичных древ
- **Поиск** — возможность найти публичные древа по названию или автору

### 7. Система подписок и международные платежи

#### Типы подписок

**Бесплатный план:**
- Создание до 3 древ
- Базовые функции кастомизации
- Ограниченное количество персонажей
- Публичные древа

**Премиум-подписка:**
- Неограниченное количество древ
- Премиум-аватары и темы
- Связывание древ между собой
- Приоритетная поддержка
- Расширенные возможности кастомизации

#### Международные платежи

Платформа поддерживает покупку подписки из-за рубежа:

**Интегрированные платежные системы:**
- **Stripe** — поддержка карт из разных стран
- **PayPal** — международные платежи
- **Яндекс.Касса** — для пользователей из России и СНГ

**Особенности:**
- Автоматическое определение валюты
- Поддержка множественных валют (USD, EUR, RUB)
- Безопасная обработка платежей
- Автоматическое продление подписки
- Возможность отмены в любой момент

**Техническая реализация:**

- Интеграция с платежными API
- Webhook'и для обработки платежей
- Управление подписками
- Уведомления о платежах
- История транзакций

## Технические детали реализации

### Работа с графовой базой данных

#### Создание персонажа и связей

**Добавление нового персонажа:**
1. Создание узла `Character` с данными
2. Связывание с деревом через `BELONGS_TO`
3. Создание связей с существующими персонажами

**Добавление связи родитель-ребенок:**
1. Проверка существования обоих персонажей
2. Создание связи `PARENT_OF`
3. Автоматическое создание обратной связи `CHILD_OF` (если нужно)
4. Обновление визуализации древа

**Добавление супруга:**
1. Создание двунаправленной связи `SPOUSE_OF`
2. Обновление информации о браке в профилях
3. Возможность указания даты брака/развода

### Визуализация графа

#### Алгоритм размещения узлов

Для красивого отображения древ используется алгоритм размещения:

- **Иерархическое размещение** — поколения на разных уровнях
- **Автоматическое позиционирование** — предотвращение пересечений
- **Интерактивное перемещение** — пользователь может двигать узлы
- **Масштабирование** — zoom in/out для больших древ
- **Панорамирование** — навигация по большому древу

#### Использование React Flow

React Flow предоставляет:
- Готовые компоненты для графов
- Интерактивность (drag & drop)
- Кастомизацию узлов и связей
- Экспорт в изображение

### Оптимизация производительности

#### Кэширование

- Кэширование структуры древ в Redis
- Кэширование визуализации
- Инкрементальная загрузка больших древ

#### Ленивая загрузка

- Загрузка древ по частям
- Подгрузка персонажей по мере необходимости
- Оптимизация запросов к графу

#### Индексация

- Индексы на часто используемые поля
- Индексы на связи между узлами
- Оптимизация графовых запросов

## Результаты разработки

### Функциональность

✅ **Графовая структура данных** — эффективное хранение сложных связей  
✅ **Неограниченное масштабирование** — поддержка любых размеров древ  
✅ **Детальные профили** — полная информация о персонажах и питомцах  
✅ **Визуальная кастомизация** — широкие возможности настройки  
✅ **Медиа-альбомы** — прикрепление фотографий  
✅ **Система подписок** — монетизация платформы  
✅ **Международные платежи** — доступность из любой страны  
✅ **Публичные/приватные древа** — контроль видимости  

### Технические достижения

- **Эффективная работа с графами** — быстрые запросы даже для больших древ
- **Масштабируемость** — поддержка тысяч пользователей и древ
- **Безопасность платежей** — надежная обработка международных транзакций
- **Производительность** — быстрая загрузка и отображение древ
- **Удобный интерфейс** — интуитивное управление сложными структурами

### Пользовательский опыт

- **Простота создания** — легкость построения древ
- **Визуальная привлекательность** — красивое отображение
- **Гибкость** — множество вариантов кастомизации
- **Социальность** — возможность делиться древами
- **Доступность** — работа из любой точки мира

## Особенности реализации

### Графы как основа архитектуры

Использование графов позволило:

- **Естественное представление** семейных связей
- **Эффективные запросы** для поиска родственников
- **Гибкость** в добавлении новых типов связей
- **Масштабируемость** для больших древ

### Кастомизация как ключевая функция

Широкие возможности настройки:

- **Визуальная идентичность** — каждый пользователь может создать уникальный стиль
- **Премиум-опции** — эксклюзивный контент для подписчиков
- **Гибкость** — от простых до сложных кастомизаций

### Международные платежи

Поддержка платежей из-за рубежа:

- **Множественные провайдеры** — Stripe, PayPal, Яндекс.Касса
- **Автоматическая конвертация** валют
- **Безопасность** — PCI DSS compliance
- **Удобство** — простой процесс оплаты

## Заключение

Разработка платформы SimsDynastyTree — это комплексный проект, демонстрирующий эффективное использование графовых структур данных для решения реальных задач. Платформа успешно объединяет:

✅ **Графовую архитектуру** для эффективного хранения связей  
✅ **Детальные профили** персонажей и питомцев  
✅ **Визуальную кастомизацию** для создания уникальных древ  
✅ **Систему подписок** с международными платежами  
✅ **Социальные функции** для обмена творениями  

Платформа показывает, как современные веб-технологии и структуры данных могут быть использованы для создания специализированных инструментов, которые решают конкретные потребности сообщества.

Если вы хотите создать подобную платформу или автоматизировать процессы в своем бизнесе, мы можем помочь разработать решение под ваши задачи.

---

**Хотите создать платформу с графовой структурой данных или автоматизировать процессы?** Свяжитесь с нами для консультации и разработки решения под ваши задачи.

